<!DOCTYPE html>
<html lang="en">

<head>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4H0ZKCWNT7"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-4H0ZKCWNT7');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check Your DR</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #1a2931;
      color: #fff;
    }

    .badge {
    cursor: pointer;
  }
    .badge:hover {
      opacity: 0.8;
    }

    .image-rounded {
      border-radius: 50%;
    }

    .popular-avatars {
      gap: 20px;
    }
    .popular-avatars img {
      width: 75px;
      height: 75px;
      cursor: pointer;
    }

    @media(max-width: 576px) {
      .popular-avatars img {
        width: 60px;
        height: 60px;
      }
    }

    .card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      background-color: #1e3441;
      color: #fff;
    }
  </style>
</head>

<body>
  <div class="container my-2">
    <div class="row justify-content-center">
      <div class="col-lg-5">
        <div class="text-center mb-4">
          <img src="/gtstats.png" class="img-fluid" alt="GT Stats" style="width: 160px;" />
        </div>
          <form id="drForm" class="mb-3">
            <div class="mb-3">
              <input type="text" class="form-control form-control-lg text-center" id="user_id" placeholder="Enter your PSN or GT Profile Link" required>
            </div>
            <div class="d-flex justify-content-center">
              <button type="submit" class="btn btn-primary btn-lg flex-grow-1">Submit</button>
            </div>
          </form>
          <div id="results" class="mt-4">
            <!-- Results will be displayed here -->
          </div>
          <div class="card mt-4">
            <div class="card-body">
              <div class="text-center text-small mb-3">
                Quick look up
              </div>
              <div class="d-flex justify-content-center popular-avatars">
                <img src="/avatar_digit.jpg" alt="Digit" data-userId="70ee665b-5cab-4ff0-ad6d-668ba1b11f91" class="image-rounded" />
                <img src="/avatar_kie.jpg" alt="Kie" data-userId="f529f2c4-5cd2-40d7-b6bb-80cbf2aab784" class="image-rounded" />
                <img src="/avatar_supergt.jpg" alt="Supergt" data-userId="d4fa38a2-9cc2-4a7d-ada9-43c23bf3692c" class="image-rounded" />
                <img src="/avatar_omega.jpg" alt="Omega" data-userId="103a27be-4a2f-4100-9bbb-054f9006037d" class="image-rounded" />
              </div>
            </div>
          </div>
          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title">About Driver Ratings</h5>
              <small>
                A+: 50,000 - 150,000, A: 30,000 - 49,999, B: 10,000 - 29,999, C: 4,000 - 9,999, D: 0 - 3,999
              </small>
            </div>
          </div>
          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title">How to Find Your Profile Link</h5>
              <small>
                Currently only 10,000 PSN names are supported, based on the top 10,000 times submitted for Rd 1 during the official Manufacturers Cup in 2024. If you're unable to look up your DR by PSN, you will need to copy your profile link from the Gran Turismo website.<br /><br />
                Visit <a href="https://www.gran-turismo.com/au/gt7/user/mymenu/" target="_blank">Gran Turismo</a> and login to your account.<br /><br />
                After visiting "My Page" copy the entire URL of your profile into the form above and your ID will be extracted.
                For example: <span class="text-secondary">https://gran-turismo.com/au/gt7/user/mymenu/12s4e6c8-1v3q-eq3c-f2lo-k2e4w6vc90gf/profile</span>
              </small>
            </div>
          </div>
      </div>

    </div>
    
  </div>

  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('user_id');

      if (userId) {
        document.getElementById('user_id').value = userId;
      }

      document.querySelectorAll('.popular-avatars img').forEach(img => {
        img.addEventListener('click', function () {
            const userId = this.getAttribute('data-userId');
            if (userId) {
                getResults(userId);
            }
        });
      });
    });

    document.getElementById('drForm').addEventListener('submit', function (event) {
      event.preventDefault(); // Prevent default form submission
      let userId = document.getElementById('user_id').value.trim();
      getResults(userId);
    });

    const sumSequence = (firstTerm, count, difference) => (count / 2) * (2 * firstTerm + (count - 1) * difference);

    const calculateRacePoints = (driverRating) => {
      const NUM_DRIVERS = 16;
      const RATING_GAP = 600;
      const POINTS_DIVISOR = 206;

      // Low estimate (user is the highest rated)
      let highestRating = driverRating;
      let sumRating = sumSequence(highestRating, NUM_DRIVERS, -RATING_GAP);
      const avgLow = sumRating / NUM_DRIVERS;
      const pointsLow = avgLow / POINTS_DIVISOR;

      // High estimate (user is the lowest rated)
      highestRating = driverRating + (15 * RATING_GAP);
      sumRating = sumSequence(highestRating, NUM_DRIVERS, -RATING_GAP);
      const avgHigh = sumRating / NUM_DRIVERS;
      const pointsHigh = avgHigh / POINTS_DIVISOR;

      return {
          low: pointsLow.toFixed(0),
          med: (driverRating / POINTS_DIVISOR).toFixed(0),
          high: pointsHigh.toFixed(0),
      };
    };

    async function getResults(userId) {
      
      const resultsDiv = document.getElementById('results');

      // Clear previous results
      resultsDiv.innerHTML = 'Please wait...';

      if (!userId) {
        resultsDiv.innerHTML = '<div class="alert alert-danger">User ID or PSN is required.</div>';
        return;
      }

      try {
        const uuidRegex = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i;
        if (!uuidRegex.test(userId)) {
          // Check if input is a GT7 profile URL and extract UUID
          const urlMatch = userId.match(/\/gt7\/user\/mymenu\/([a-f0-9-]{36})\/profile/i);
          if (urlMatch) {
            userId = urlMatch[1]; // Extracted UUID
          } else {
            // Attempt to fetch UUID by PSN
            const psnResponse = await fetch(`/getUserByPsn?psn=${encodeURIComponent(userId)}`);
            const psnData = await psnResponse.json();

            if (!psnResponse.ok || !psnData.user_id) {
              resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                  <strong>Error:</strong> PSN not found, please try your Gran Turismo profile link.
                </div>
              `;
              return;
            }

            userId = psnData.user_id; // Update userId with the fetched value
          }
        }

        // Fetch results from the /json endpoint
        const response = await fetch(`/json?user_id=${encodeURIComponent(userId)}`);
        const data = await response.json();

        if (response.ok) {
          const racePoints = calculateRacePoints(data.dr);
          resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>PSN:</strong> ${data.psn}<br>
                            <strong>Driver Name:</strong> ${data.driver_name}<br>
                            <strong>Driver Rating:</strong> ${data.dr}<br>
                            <strong>Driver Rank:</strong> ${data.rank}<br>
                            <strong>GTWS Points Est:</strong> ${racePoints.med } <small>(▼${ racePoints.low } - ▲${ racePoints.high })</small>
                        </div>
                    `;
        } else {
          resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${data.error || 'An unknown error occurred.'}
                        </div>
                    `;
        }
      } catch (error) {
        resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message || 'Failed to fetch results.'}
                    </div>
                `;
      }
    }
  </script>
</body>
</html>